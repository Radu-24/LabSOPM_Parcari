<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PlatÄƒ â€” ParkingApp</title>
  <link rel="stylesheet" href="css/pag3.css">
</head>
<body>
  <div class="page">
    <!-- Rezumat (din pagina 2) -->
    <section class="card summary" aria-live="polite">
      <h1>FinalizeazÄƒ plata</h1>
      <p class="muted">Alege metoda doritÄƒ:</p>
      <dl id="sumOut">
        <dt>Parcare:</dt>  <dd id="s_name">â€”</dd>
        <dt>DuratÄƒ:</dt>   <dd id="s_hours">â€”</dd>
        <dt>Tarif/orÄƒ:</dt><dd id="s_rate">â€”</dd>
        <dt>Total:</dt>    <dd id="s_total">â€”</dd>
      </dl>
    </section>

    <!-- Metode de platÄƒ -->
    <section class="card">
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="card"  aria-selected="true">ðŸ’³ Card</button>
        <button class="tab"         data-tab="apple">ï£¿ Apple Pay</button>
        <button class="tab"         data-tab="sms">ðŸ“© SMS</button>
      </div>

      <!-- Card -->
      <form id="formCard" class="payform show" autocomplete="off">
        <div class="field">
          <label for="ccName">Nume pe card</label>
          <input id="ccName" placeholder="EX: POPESCU ION" required />
        </div>
        <div class="field">
          <label for="ccExpiry">Expirare</label>
          <input id="ccExpiry" placeholder="LL/AA" maxlength="5" required />
          <div class="help">ex: 09/28</div>
        </div>
        <div class="field">
          <label for="ccCvv">CVV</label>
          <input id="ccCvv" inputmode="numeric" maxlength="3" placeholder="123" required />
        </div>
        <div class="actions">
          <button type="submit" class="btn">PlÄƒteÈ™te acum</button>
        </div>
      </form>

      <!-- Apple Pay (simulat) -->
      <form id="formApple" class="payform" autocomplete="off">
        <div class="actions">
          <button type="submit" class="btn apple">PlÄƒteÈ™te cu Apple Pay</button>
        </div>
      </form>

      <!-- SMS -->
      <form id="formSms" class="payform" autocomplete="off">
        <div class="field">
          <label for="phone">NumÄƒr telefon</label>
          <input id="phone" placeholder="07xx xxx xxx" required />
          <div class="help">PrimeÈ™ti un cod prin SMS (simulat).</div>
        </div>
        <div class="actions">
          <button type="submit" class="btn">PlÄƒteÈ™te prin SMS</button>
        </div>
      </form>
    </section>
  </div>

  <script>
    // ==== HELPERI ====
    const $ = s => document.querySelector(s);
    const fmtRON = n => new Intl.NumberFormat('ro-RO',{style:'currency',currency:'RON'}).format(Number(n||0));

    // DuratÄƒ corectÄƒ: "75 minute (1.25 h)"
    const formatDurationBlock = (mins) => {
      if (mins == null || isNaN(mins)) return 'â€”';
      const m = Math.max(0, Math.round(mins));
      const hoursDecimal = (m / 60).toFixed(2);
      return `${m} minute (${hoursDecimal} h)`;
    };

    // date venite din pagina 2: ?zone=&minutes=&price=&start=&name=&zoneLabel=
    const qs = new URLSearchParams(location.search);
    const params = {
      zone: qs.get('zone') || '1',
      minutes: qs.get('minutes') != null ? Number(qs.get('minutes')) : 60,
      price: Number(qs.get('price') || 0),
      start: qs.get('start') || '',
      name: qs.get('name') ? decodeURIComponent(qs.get('name')) : null,
      zoneLabel: qs.get('zoneLabel') || null
    };

    // fallback pentru numele zonei dacÄƒ nu primim zoneLabel
    const ZONE_NAMES = {
      "1": "Zona 0 â€” Poiana BraÈ™ov",
      "2": "Zona 0 â€” Centrul Vechi",
      "3": "Zona 1 â€” Perimetru",
      "4": "Zona 2 â€” Periferie"
    };

    // tarif/orÄƒ derivat dacÄƒ avem price È™i minutes
    const hours = Math.max(0.25, params.minutes/60); // minim 15 min = 0.25 h
    const rate = params.price && hours ? (params.price / hours) : null;

    // textul pentru "Parcare"
    const parkText = params.zoneLabel || params.name || ZONE_NAMES[params.zone] || 'â€”';

    // populare rezumat
    $('#s_name').textContent   = parkText;
    $('#s_hours').textContent  = formatDurationBlock(params.minutes);
    $('#s_rate').textContent   = rate ? fmtRON(rate) + '/h' : 'â€”';
    $('#s_total').textContent  = fmtRON(params.price);

    // ==== TABURI ====
    const tabs = document.querySelectorAll('.tab');
    const forms = document.querySelectorAll('.payform');
    const map = { card:'#formCard', apple:'#formApple', sms:'#formSms' };

    tabs.forEach(t => t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      forms.forEach(f=>f.classList.remove('show'));
      const sel = map[t.dataset.tab]; if(sel) document.querySelector(sel).classList.add('show');
    }));

    // UX: formatÄƒm LL/AA la expirare
    const exp = document.getElementById('ccExpiry');
    if (exp) {
      exp.addEventListener('input', (e)=>{
        let v = e.target.value.replace(/\D/g,'').slice(0,4);
        if(v.length>2) v = v.slice(0,2)+'/'+v.slice(2);
        e.target.value = v;
      });
    }

    // UX: CVV exact 3 cifre
    const cvv = document.getElementById('ccCvv');
    if (cvv) {
      cvv.setAttribute('maxlength','3');
      cvv.setAttribute('inputmode','numeric');
      cvv.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g,'').slice(0,3);
      });
    }

    // ==== REDIRECT LA PAG4 PENTRU ORICE METODÄ‚ ====
    ['formCard','formApple','formSms'].forEach(id=>{
      const form = document.getElementById(id);
      if(!form) return;
      form.addEventListener('submit', e=>{
        e.preventDefault();

        if(id==='formCard'){
          if(!document.getElementById('ccName').value.trim()) return alert('Introdu numele de pe card.');
          if(!/^\d{2}\/\d{2}$/.test(document.getElementById('ccExpiry').value.trim())) return alert('Expirare LL/AA.');
          if(!/^\d{3}$/.test(document.getElementById('ccCvv').value.trim())) return alert('CVV trebuie sÄƒ aibÄƒ exact 3 cifre.');
        }
        if(id==='formSms'){
          if(!document.getElementById('phone').value.trim()) return alert('Introdu numÄƒrul de telefon.');
        }

        const method = id.replace('form','').toUpperCase(); // CARD / APPLE / SMS
        const out = new URLSearchParams({
          method,
          zone: params.zone,
          minutes: params.minutes,
          price: params.price.toFixed(2),
          start: params.start,
          // pÄƒstrÄƒm textul pentru pag4
          zoneLabel: parkText
        });
        window.location.href = `pag4.html?${out.toString()}`;
      });
    });
  </script>
</body>
</html>
