<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plată — ParkingApp</title>
  <link rel="stylesheet" href="css/pag3.css">
</head>
<body>
  <div class="page">
    <!-- Rezumat (din pagina 2) -->
    <section class="card summary" aria-live="polite">
      <h1>Finalizează plata</h1>
      <p class="muted">Alege metoda dorită:</p>
      <dl id="sumOut">
        <dt>Parcare:</dt>  <dd id="s_name">—</dd>
        <dt>Durată:</dt>   <dd id="s_hours">—</dd>
        <dt>Tarif/oră:</dt><dd id="s_rate">—</dd>
        <dt>Total:</dt>    <dd id="s_total">—</dd>
      </dl>
    </section>

    <!-- Metode de plată -->
    <section class="card">
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="card"  aria-selected="true">💳 Card</button>
        <button class="tab"         data-tab="apple"> Apple Pay</button>
        <button class="tab"         data-tab="sms">📩 SMS</button>
      </div>

      <!-- Card -->
      <form id="formCard" class="payform show" autocomplete="off" novalidate>
        <div class="field">
          <label for="ccName">Nume pe card</label>
          <input
            id="ccName"
            placeholder="EX: POPESCU ION"
            autocomplete="cc-name"
            inputmode="text"
            spellcheck="false"
            required
          />
        </div>

        <div class="field">
          <label for="ccExpiry">Expirare</label>
          <input id="ccExpiry" placeholder="LL/AA" maxlength="5" required />
          <div class="help">ex: 09/28</div>
        </div>

        <div class="field">
          <label for="ccCvv">CVV</label>
          <input id="ccCvv" type="password" inputmode="numeric" maxlength="3" placeholder="123" required />
        </div>

        <div class="actions">
          <button type="submit" class="btn">Plătește acum</button>
        </div>
      </form>

      <!-- Apple Pay (simulat) -->
      <form id="formApple" class="payform" autocomplete="off">
        <div class="actions">
          <button type="submit" class="btn apple">Plătește cu Apple Pay</button>
        </div>
      </form>

      <!-- SMS -->
      <form id="formSms" class="payform" autocomplete="off" novalidate>
        <div class="field">
          <label for="phone">Număr telefon</label>
          <input
            id="phone"
            placeholder="07xxxxxxxx"
            inputmode="numeric"
            pattern="\d*"
            maxlength="15"
            required
          />
          <div class="help">Primești un cod prin SMS (simulat).</div>
        </div>
        <div class="actions">
          <button type="submit" class="btn">Plătește prin SMS</button>
        </div>
      </form>
    </section>
  </div>

  <script>
    // ==== HELPERI ====
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    const fmtRON = (n) => new Intl.NumberFormat('ro-RO',{style:'currency',currency:'RON'}).format(Number(n||0));

    // Durată corectă: "75 minute (1.25 h)"
    function formatDurationBlock(mins){
      if (mins == null || isNaN(mins)) return '—';
      const m = Math.max(0, Math.round(mins));
      const hoursDecimal = (m / 60).toFixed(2);
      return `${m} minute (${hoursDecimal} h)`;
    }

    // ==== PARAMETRI DIN URL (din pag.2) ====
    // așteptăm ideal: ?zone=&minutes=&price=&start=&zoneLabel=&name=
    const qs = new URLSearchParams(location.search);
    const params = {
      zone: qs.get('zone') || '1',
      minutes: qs.get('minutes') != null ? Number(qs.get('minutes')) : 60,
      price: Number(qs.get('price') || 0),
      start: qs.get('start') || '',
      zoneLabel: qs.get('zoneLabel') || null,
      name: qs.get('name') ? decodeURIComponent(qs.get('name')) : null
    };

    // fallback pentru numele zonei dacă nu primim zoneLabel
    const ZONE_NAMES = {
      "1": "Zona 0 — Poiana Brașov",
      "2": "Zona 0 — Centrul Vechi",
      "3": "Zona 1 — Perimetru",
      "4": "Zona 2 — Periferie"
    };

    // tarif/oră derivat dacă avem price și minutes
    const hours = Math.max(0.25, params.minutes/60); // minim 15 min = 0.25 h
    const rate = params.price && hours ? (params.price / hours) : null;

    // textul pentru "Parcare"
    const parkText = params.zoneLabel || params.name || ZONE_NAMES[params.zone] || '—';

    // ==== POPULARE REZUMAT ====
    $('#s_name').textContent   = parkText;
    $('#s_hours').textContent  = formatDurationBlock(params.minutes);
    $('#s_rate').textContent   = rate ? fmtRON(rate) + '/h' : '—';
    $('#s_total').textContent  = fmtRON(params.price);

    // ==== TABURI ====
    const tabMap = { card:'#formCard', apple:'#formApple', sms:'#formSms' };
    $$('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        $$('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        $$('.payform').forEach(f => f.classList.remove('show'));
        const target = tabMap[tab.dataset.tab];
        if (target) document.querySelector(target).classList.add('show');
      });
    });

    // ==== INPUT MASKS ====
    // Nume pe card: doar litere (și diacritice), spații, '-' și '’'
    const nameInput = document.getElementById('ccName');
    if (nameInput) {
      nameInput.addEventListener('input', (e) => {
        e.target.value = e.target.value
          .normalize('NFC')
          .replace(/[^A-Za-zĂÂÎȘŞȚŢăâîșşțţ \-’']/g, '')  // litere RO + spații + - + ’
          .replace(/\s{2,}/g, ' ')                        // compactează spațiile multiple
          .replace(/^\s+/, '');                           // taie spațiul inițial
      });
    }

    // Expirare LL/AA – auto-formatare
    const exp = document.getElementById('ccExpiry');
    if (exp) {
      exp.addEventListener('input', (e)=>{
        let v = e.target.value.replace(/\D/g,'').slice(0,4);
        if (v.length > 2) v = v.slice(0,2) + '/' + v.slice(2);
        e.target.value = v;
      });
    }

    // CVV – doar 3 cifre
    const cvv = document.getElementById('ccCvv');
    if (cvv) {
      cvv.setAttribute('maxlength','3');
      cvv.setAttribute('inputmode','numeric');
      cvv.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g,'').slice(0,3);
      });
    }

    // Telefon – doar cifre (și la tastare, și la paste), + validare minim 10 cifre
    const phone = document.getElementById('phone');
    if (phone) {
      const keepDigits = (val) => val.replace(/\D/g,'');
      ['input','paste','change','blur'].forEach(evt => {
        phone.addEventListener(evt, (e) => {
          const clean = keepDigits(e.target.value);
          if (e.target.value !== clean) e.target.value = clean;
        });
      });
    }

    // ==== SUBMIT & REDIRECT LA PAG4 ====
    ['formCard','formApple','formSms'].forEach(id => {
      const form = document.getElementById(id);
      if (!form) return;

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        // Validări specifice
        if (id === 'formCard') {
          const nameVal = nameInput.value.trim();
          const allowedChars = /^[A-Za-zĂÂÎȘŞȚŢăâîșşțţ '\-’]+$/;   // DOAR caractere permise
          const hasTwoWords  = nameVal.split(/\s+/).length >= 2;   // minim două cuvinte

          if (!allowedChars.test(nameVal) || !hasTwoWords) {
            alert('Numele trebuie să conțină doar litere (cu diacritice), spații, - sau ’ și cel puțin două cuvinte.');
            return;
          }
          if (!/^\d{2}\/\d{2}$/.test($('#ccExpiry').value.trim())) { alert('Expirare LL/AA.'); return; }
          if (!/^\d{3}$/.test($('#ccCvv').value.trim())) { alert('CVV trebuie să aibă exact 3 cifre.'); return; }
        }

        if (id === 'formSms') {
          const digits = ($('#phone').value || '').replace(/\D/g,'');
          if (digits.length < 10) {
            alert('Introdu un număr valid (minim 10 cifre).');
            return;
          }
        }

        const method = id.replace('form','').toUpperCase(); // CARD / APPLE / SMS

        // Păstrăm parametrii și ne asigurăm că trimitem zoneLabel către pag4
        const out = new URLSearchParams({
          method,
          zone: params.zone,
          minutes: params.minutes,
          price: params.price.toFixed(2),
          start: params.start,
          zoneLabel: (params.zoneLabel || params.name || ZONE_NAMES[params.zone] || '—')
        });

        if (params.name) out.set('name', params.name);

        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.disabled = true;

        window.location.href = `pag4.html?${out.toString()}`;
      });
    });
  </script>
</body>
</html>
