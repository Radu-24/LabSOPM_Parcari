<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parking Finder – Brașov</title>

  <!-- ==============================
       LEAFLET CSS (MAP + DRAW)
       ============================== -->
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <!-- ==============================
       APP STYLES (LAYOUT + THEME + UI)
       ============================== -->
  <style>
    /* ====== PAGE + MAP CANVAS ====== */
    html, body, #map { height: 100%; margin: 0; }
    #map { position: relative; z-index: 0; }

    /* ====== FLOATING UI CONTAINERS ====== */
    .ui-top-right{ position: fixed; top:12px; right:12px; display:flex; flex-direction:column; gap:10px; z-index:2147483647; pointer-events:none; }
    .ui-top-right>*{ pointer-events:auto; }

    .ui-top-center{ position: fixed; top:12px; left:50%; transform:translateX(-50%); display:flex; justify-content:center; z-index:2147483647; pointer-events:none; }
    .ui-top-center>*{ pointer-events:auto; }

    .ui-bottom-right{ position: fixed; right:12px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:2147483647; pointer-events:none; }
    .ui-bottom-right>*{ pointer-events:auto; }

    /* ====== BUTTONS (FAB / ADMIN / BACK) ====== */
    .fab{ padding:12px 18px; border-radius:999px; border:0; background:#111; color:#fff; font:600 15px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; box-shadow:0 6px 18px rgba(0,0,0,.3); cursor:pointer; user-select:none; opacity:.95; transition:opacity .2s; }
    .fab:hover{ opacity:1; }
    .fab.light{ background:#fff; color:#111; }

    .admin-btn{ padding:12px 18px; border-radius:999px; border:0; background:#0d6efd; color:#fff; font:700 15px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; box-shadow:0 6px 18px rgba(0,0,0,.35); cursor:pointer; user-select:none; opacity:.98; }
    .back-btn{ padding:10px 16px; border-radius:999px; border:0; background:#222; color:#fff; font:600 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; box-shadow:0 6px 18px rgba(0,0,0,.35); cursor:pointer; user-select:none; opacity:.96; display:none; }
    .back-btn.light{ background:#fff; color:#111; }

    /* ====== MAP ATTRIBUTION + TILE FX ====== */
    .leaflet-control-attribution{ font-size:10px !important; opacity:.65; bottom:4px !important; right:4px !important; left:auto !important; pointer-events:none !important; }
    .night-soft-tiles{ filter: invert(85%) sepia(10%) saturate(115%) hue-rotate(190deg) brightness(88%) contrast(96%); }
    .leaflet-overlay-pane .zone-outline{ filter: drop-shadow(0 0 2px rgba(0,0,0,.35)); }

    /* ====== ADMIN PANEL (SIDECARD) ====== */
    .admin-panel{ position: fixed; right:12px; bottom:68px; width:min(520px,92vw); max-height:60vh; overflow:auto; background:rgba(17,17,17,.96); color:#fff; border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:12px; box-shadow:0 10px 24px rgba(0,0,0,.4); z-index:2147483000; display:none; font:13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .admin-panel.light{ background:#fff; color:#111; border-color:rgba(0,0,0,.15); }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .row + .row{ margin-top:8px; }
    .btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:transparent; color:inherit; cursor:pointer; }
    .btn.good{ background:#198754; color:#fff; border-color:#198754; }
    .btn.warn{ background:#dc3545; color:#fff; border-color:#dc3545; }

    select,input{ padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:transparent; color:inherit; }
    .admin-panel.light select,.admin-panel.light input{ border-color:rgba(0,0,0,.2); }
    .draw-on{ background:#198754 !important; border-color:#198754 !important; color:#fff !important; }

    /* ====== MODAL (PASSWORD PROMPT) ====== */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2147483500; display:none; }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2147483600; }
    .modal-card{ width:min(360px,92vw); background:#111; color:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .modal-card h3{ margin:0 0 10px 0; font-size:16px; }
    .modal-card input{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:transparent; color:#fff; }
    .modal-actions{ display:flex; gap:8px; margin-top:12px; justify-content:flex-end; }
    .btn.primary{ background:#0d6efd; color:#fff; border-color:#0d6efd; }

    /* === WEATHER WIDGET (nou) === */
    .ui-top-left{ position:fixed; top:12px; left:12px; z-index:2147483647; pointer-events:none; }
    .ui-top-left>*{ pointer-events:auto; }

    .weather-card{
      min-width: 180px;
      max-width: 220px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      background:rgba(17,17,17,.92); color:#fff;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .weather-card.light{ background:#fff; color:#111; border-color:rgba(0,0,0,.15); }
    .weather-icon{ width:42px; height:42px; flex:0 0 42px; }
    .weather-main{ display:flex; flex-direction:column; }
    .weather-title{ font-weight:700; font-size:13px; }
    .weather-sub{ opacity:.8; font-size:12px; }
    .weather-temp{ font-size:16px; font-weight:800; }
    /* === END WEATHER WIDGET === */
  </style>
</head>
<body>
  <!-- ==============================
       MAP CONTAINER
       ============================== -->
  <div id="map"></div>

  <!-- ==============================
       WEATHER WIDGET (TOP-LEFT)
       ============================== -->
  <div class="ui-top-left">
    <div id="wxCard" class="weather-card" aria-live="polite" aria-label="Vreme Brașov">
      <img id="wxIcon" class="weather-icon" alt="iconiță meteo" />
      <div class="weather-main">
        <div class="weather-title">Brașov</div>
        <div class="weather-temp" id="wxTemp">--°C</div>
        <div class="weather-sub" id="wxDesc">Se încarcă…</div>
      </div>
    </div>
  </div>
  <!-- === END WEATHER WIDGET (nou) === -->

  <!-- ==============================
       THEME TOGGLE (TOP-RIGHT)
       ============================== -->
  <div class="ui-top-right">
    <button id="themeBtn" class="fab">☀ Light</button>
  </div>

  <!-- ==============================
       BACK BUTTON (TOP-CENTER)
       ============================== -->
  <div class="ui-top-center">
    <button id="backBtn" class="back-btn">⟵ Back to City</button>
  </div>

  <!-- ==============================
       ADMIN BUTTON (BOTTOM-RIGHT)
       ============================== -->
  <div class="ui-bottom-right">
    <button id="adminBtn" class="admin-btn">Admin</button>
  </div>

  <!-- ==============================
       ADMIN PANEL (SIDEBAR)
       ============================== -->
  <div id="adminPanel" class="admin-panel" aria-hidden="true">
    <div class="row" style="justify-content:space-between;">
      <strong>Admin – edit zones</strong>
      <button id="closeAdmin" class="btn">Close</button>
    </div>
    <div class="row">
      <label for="areaSelect">Zone:</label>
      <select id="areaSelect"></select>
      <button id="drawToggle" class="btn">✏ Draw</button>
      <button id="saveBtn" class="btn good">Save</button>
      <button id="clearBtn" class="btn warn">Clear</button>
    </div>
    <div class="row" style="font-size:12px; opacity:.8;">
      Tip: Enter Draw, edit/add polygon. Click <em>Save</em> to update outlines.
    </div>
  </div>

  <!-- ==============================
       PASSWORD MODAL (ADMIN ACCESS)
       ============================== -->
  <div id="modalBackdrop" class="modal-backdrop"></div>
  <div id="passModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Enter Admin Password</h3>
      <input id="passInput" type="password" placeholder="Password" />
      <div class="modal-actions">
        <button id="passCancel" class="btn">Cancel</button>
        <button id="passOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- ==============================
       LEAFLET JS (MAP + DRAW)
       ============================== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- ==============================
       APP CORE SCRIPT
       ============================== -->
  <script>
    // ===== View constants =====
    const CITY_CENTER = [45.643, 25.588];
    const FIXED_ZOOM  = 12.5;
    const CENTER_NUDGE = -0.005;
    const DEFAULT_CENTER = [CITY_CENTER[0] + CENTER_NUDGE, CITY_CENTER[1]];

    // ===== Base layers =====
    const osmLight = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 });
    const voyagerNightSoft = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', { maxZoom: 20, className: 'night-soft-tiles' });

    // ===== Map (locked) =====
    const map = L.map('map', {
      center: DEFAULT_CENTER,
      zoom: FIXED_ZOOM,
      zoomSnap: 0.5,
      zoomControl: false,
      dragging: false, scrollWheelZoom: false, doubleClickZoom: false,
      boxZoom: false, keyboard: false, touchZoom: false
    });
    window.map = map;
    map.setMinZoom(FIXED_ZOOM);
    map.setMaxZoom(FIXED_ZOOM);

    let HOME_CENTER = null, HOME_ZOOM = null;
    map.whenReady(() => { HOME_CENTER = map.getCenter(); HOME_ZOOM = map.getZoom(); });

    // ===== Theme =====
    const themeBtn = document.getElementById('themeBtn');
    const adminPanel = document.getElementById('adminPanel');
    const backBtn = document.getElementById('backBtn');
    let currentBase = null;

    function applyTheme(mode){
      if (currentBase) { map.removeLayer(currentBase); currentBase = null; }
      if (mode === 'light'){
        currentBase = osmLight;
        themeBtn.textContent = '🌙 Night';
        themeBtn.classList.add('light');
        adminPanel.classList.add('light');
        backBtn.classList.add('light');
      } else {
        currentBase = voyagerNightSoft;
        themeBtn.textContent = '☀ Light';
        themeBtn.classList.remove('light');
        adminPanel.classList.remove('light');
        backBtn.classList.remove('light');
      }
      currentBase.addTo(map);
      localStorage.setItem('pf_theme', mode);
      requestAnimationFrame(()=>map.invalidateSize(true));
    }
    const savedTheme = (localStorage.getItem('pf_theme') === 'light') ? 'light' : 'nightsoft';
    applyTheme(savedTheme);
    themeBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); applyTheme((localStorage.getItem('pf_theme')==='light')?'nightsoft':'light'); }, { capture:true, passive:false });

    // ===== Zones =====
    let ZONES = [
      { id:1, title:"Zona 0 – Poiana Brașov", coords:[[45.587238,25.547294],[45.587132,25.548417],[45.586792,25.549873],[45.586283,25.551209],[45.586028,25.553029],[45.586325,25.554456],[45.586941,25.555518],[45.587514,25.556276],[45.587706,25.557399],[45.588024,25.558309],[45.588831,25.558916],[45.589808,25.559098],[45.590742,25.558886],[45.591825,25.559068],[45.592526,25.559796],[45.593184,25.561162],[45.593906,25.562679],[45.594246,25.564197],[45.594607,25.565562],[45.594904,25.567231],[45.595435,25.568293],[45.596242,25.568324],[45.596985,25.567808],[45.597304,25.566624],[45.597834,25.564925],[45.598259,25.563741],[45.598854,25.562619],[45.599215,25.561617],[45.599703,25.560676],[45.600382,25.559614],[45.601168,25.557763],[45.601486,25.556458],[45.601699,25.554941],[45.60155,25.553545],[45.600998,25.552544],[45.600149,25.551451],[45.599618,25.55045],[45.599045,25.549691],[45.59862,25.548599],[45.59828,25.547597],[45.597856,25.546293],[45.59741,25.545655],[45.596518,25.545261],[45.595202,25.545534],[45.594352,25.546414],[45.593121,25.547233],[45.592186,25.547082],[45.591294,25.546566],[45.590445,25.546019],[45.589511,25.545473],[45.588576,25.545321],[45.587939,25.545625],[45.587472,25.54611],[45.58726,25.546717]]},
      { id:2, title:"Zona 0 – Centrul Vechi", coords:[[45.621652,25.563256],[45.622756,25.565562],[45.623987,25.56714],[45.625006,25.569628],[45.625557,25.571935],[45.625812,25.576669],[45.626321,25.578914],[45.626916,25.581585],[45.628104,25.583587],[45.629971,25.584801],[45.631754,25.586015],[45.633197,25.587411],[45.634088,25.588868],[45.635743,25.590142],[45.637271,25.592145],[45.638671,25.594694],[45.63969,25.59694],[45.640538,25.599185],[45.641588,25.601835],[45.643118,25.603638],[45.644558,25.606298],[45.645728,25.606985],[45.647168,25.606256],[45.647798,25.605011],[45.648698,25.60441],[45.650168,25.603681],[45.651951,25.60222],[45.652588,25.600217],[45.652885,25.596818],[45.653224,25.593541],[45.653606,25.59087],[45.653309,25.587957],[45.652376,25.585287],[45.650594,25.582616],[45.649024,25.580189],[45.64703,25.577943],[45.646691,25.575455],[45.645587,25.572481],[45.644399,25.5689],[45.643593,25.565987],[45.642066,25.563499],[45.640284,25.562224],[45.638756,25.562163],[45.636167,25.562952],[45.633112,25.563741],[45.630693,25.563923],[45.62925,25.563499],[45.627977,25.562588],[45.626873,25.561496],[45.62509,25.559675],[45.623435,25.559311],[45.622162,25.559918],[45.621355,25.561071],[45.621185,25.562224]]},
      { id:3, title:"Zona 1", coords:[[45.651612,25.556276],[45.650976,25.557672],[45.6514,25.560464],[45.650848,25.562952],[45.65,25.565137],[45.648897,25.568718],[45.649024,25.571874],[45.649279,25.575455],[45.649533,25.579278],[45.650594,25.582131],[45.651654,25.583405],[45.652715,25.585408],[45.653564,25.587229],[45.653861,25.589535],[45.653988,25.591842],[45.653394,25.594937],[45.653224,25.59785],[45.652927,25.60052],[45.652291,25.602645],[45.650848,25.603798],[45.649491,25.604708],[45.648091,25.605436],[45.646691,25.607196],[45.645206,25.607682],[45.644272,25.606772],[45.643551,25.605254],[45.64283,25.604314],[45.642002,25.603889],[45.641175,25.604738],[45.640347,25.605952],[45.639286,25.60747],[45.638798,25.609928],[45.638162,25.613751],[45.638077,25.618546],[45.639095,25.622127],[45.641344,25.626132],[45.643466,25.630441],[45.646309,25.63469],[45.650467,25.635964],[45.653351,25.633719],[45.655982,25.631837],[45.659672,25.629834],[45.66086,25.628317],[45.661072,25.624554],[45.660902,25.620184],[45.661666,25.615572],[45.662132,25.609806],[45.662726,25.60574],[45.663871,25.598882],[45.665822,25.59524],[45.666289,25.589778],[45.665314,25.585226],[45.663956,25.579218],[45.662429,25.575333],[45.660478,25.57236],[45.658739,25.570175],[45.657212,25.56805],[45.6556,25.564834],[45.654539,25.559736],[45.653691,25.55573],[45.652885,25.55482],[45.651994,25.555184]]},
      { id:4, title:"Zona 2", coords:[[45.653288,25.554457],[45.654068,25.551023],[45.655088,25.547419],[45.657188,25.545702],[45.660487,25.545359],[45.663067,25.549049],[45.665106,25.550251],[45.667026,25.549479],[45.670204,25.548363],[45.673083,25.550337],[45.675962,25.562096],[45.678721,25.567245],[45.682558,25.572567],[45.685676,25.578918],[45.688315,25.586128],[45.689034,25.596085],[45.688674,25.606728],[45.685197,25.618916],[45.681599,25.628185],[45.675722,25.63488],[45.667925,25.637283],[45.662527,25.637627],[45.659048,25.641575],[45.656408,25.647068],[45.651968,25.654793],[45.647288,25.655136],[45.642248,25.653763],[45.639608,25.646553],[45.635167,25.647068],[45.630365,25.648613],[45.625203,25.652218],[45.622202,25.654449],[45.614998,25.657196],[45.612356,25.657196],[45.610675,25.653934],[45.609955,25.644665],[45.609955,25.636597],[45.611636,25.627842],[45.616079,25.621319],[45.619561,25.618057],[45.623643,25.616169],[45.627484,25.616169],[45.630965,25.615997],[45.632406,25.612907],[45.631566,25.608444],[45.628565,25.605183],[45.625083,25.601063],[45.622082,25.596771],[45.621962,25.591793],[45.626404,25.591793],[45.629525,25.59351],[45.634206,25.600548],[45.636367,25.603123],[45.638407,25.606041],[45.638827,25.606728],[45.639007,25.607715],[45.638677,25.609603],[45.638257,25.611963],[45.637777,25.613637],[45.637807,25.616469],[45.637897,25.618658],[45.638617,25.62149],[45.640028,25.624495],[45.641438,25.627027],[45.642532,25.62947],[45.644018,25.632019],[45.645545,25.63475],[45.6472,25.636025],[45.64983,25.63651],[45.651909,25.636086],[45.661242,25.629045],[45.661835,25.627407],[45.661623,25.624554],[45.661581,25.621398],[45.661793,25.617575],[45.662132,25.613144],[45.662684,25.608774],[45.663405,25.603798],[45.663999,25.600217],[45.664974,25.598093],[45.666119,25.595969],[45.666501,25.593844],[45.666671,25.59087],[45.666671,25.588139],[45.666119,25.585894],[45.665441,25.583587],[45.664423,25.578854],[45.662641,25.57418],[45.661539,25.572724],[45.65963,25.570478],[45.658484,25.568536],[45.657127,25.566837],[45.656406,25.564773],[45.655388,25.561739],[45.654539,25.55834],[45.6542,25.556094],[45.653733,25.555245]]}
    ];

    // ===== Styles =====
    const styleMap = {
      "Zona 0 – Poiana Brașov": { color:'#1e90ff', weight:5, opacity:0.95, fill:true, fillOpacity:0.001, className:'zone-outline' },
      "Zona 0 – Centrul Vechi": { color:'#1e90ff', weight:5, opacity:0.95, fill:true, fillOpacity:0.001, className:'zone-outline' },
      "Zona 1":                 { color:'#21d4d4', weight:5, opacity:0.95, fill:true, fillOpacity:0.001, className:'zone-outline' },
      "Zona 2":                 { color:'#ff3b3b', weight:6, opacity:0.95, fill:true, fillOpacity:0.001, className:'zone-outline' }
    };
    const outlines = new Map();

    // ===== Editor state (Leaflet.draw) =====
    const drawnItems = new L.FeatureGroup().addTo(map);
    let drawControl=null, zoomCtrl=null, inDrawMode=false;

    // ===== Focus / navigate state =====
    let hoverEnabled = true;
    let focusedLayer = null;
    let mapClickHandler = null;
    let suppressNextMapClick = false;
    let allowNavigate = false;

    // ===== Map interaction toggles =====
    function enableFreeMap(){
      map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable();
      map.boxZoom.enable(); map.keyboard.enable(); map.touchZoom.enable();
      map.setMinZoom(10); map.setMaxZoom(19);
      if (!zoomCtrl) zoomCtrl = L.control.zoom({position:'topleft'}).addTo(map);
    }
    function lockMap(){
      map.setMinZoom(FIXED_ZOOM); map.setMaxZoom(FIXED_ZOOM);
      map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable();
      map.boxZoom.disable(); map.keyboard.disable(); map.touchZoom.disable();
      if (zoomCtrl){ map.removeControl(zoomCtrl); zoomCtrl=null; }
    }

    // ===== Geometry util: point in polygon =====
    function pointInPolygon(latlng, polyLatLngs) {
      const rings = Array.isArray(polyLatLngs[0]) ? polyLatLngs : [polyLatLngs];
      const x = latlng.lng, y = latlng.lat;
      let inside = false;
      for (let r = 0; r < rings.length; r++) {
        const ring = rings[r];
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
          const xi = ring[i].lng, yi = ring[i].lat;
          const xj = ring[j].lng, yj = ring[j].lat;
          const intersect = ((yi > y) !== (yj > y)) &&
                            (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
          if (intersect) inside = !inside;
        }
        if (inside) return true;
      }
      return false;
    }

    // ===== Reset to home view =====
    function goHome(){
      hoverEnabled = true;
      backBtn.style.display = 'none';

      if (mapClickHandler) { map.off('click', mapClickHandler); mapClickHandler = null; }
      focusedLayer = null;
      allowNavigate = false;
      suppressNextMapClick = false;

      if (drawControl){ try{ map.removeControl(drawControl); }catch{}; drawControl=null; }
      inDrawMode = false;

      if (typeof disableCursorRing === 'function') disableCursorRing();
      lockMap();

      const center = HOME_CENTER || DEFAULT_CENTER;
      const zoom   = HOME_ZOOM   || FIXED_ZOOM;
      map.stop(); map.closePopup();
      map.setView(center, zoom, { animate:false });

      map.invalidateSize(true);
      requestAnimationFrame(()=>map.setView(center, zoom, { animate:false }));
      setTimeout(()=>{ map.setView(center, zoom, { animate:false }); map.invalidateSize(true); }, 0);
      map.once('moveend', ()=>setTimeout(()=>map.invalidateSize(true), 0));
    }

    // ===== Hover styling for zones =====
    function attachHover(layer, baseColor){
      layer.on('mouseover', () => {
        if (!hoverEnabled) return;
        layer.bringToFront();
        layer.setStyle({ fill: true, fillColor: baseColor, fillOpacity: 0.22 });
      });
      layer.on('mouseout', () => {
        if (!hoverEnabled) return;
        layer.setStyle({ fill: true, fillColor: baseColor, fillOpacity: 0.001 });
      });
    }

    // ===== Focus a zone (zoom + ring + navigation arming) =====
    function focusLayer(layer){
      if (inDrawMode) return;
      hoverEnabled = false;
      backBtn.style.display = 'inline-block';

      // reset all styles
      outlines.forEach((l, t) => {
        const base = styleMap[t] || { color:'#ffd400', weight:4, opacity:0.95, fill:true, fillOpacity:0.001 };
        l.setStyle({ color: base.color, weight: base.weight, opacity: base.opacity, fill:true, fillColor: base.color, fillOpacity: 0.001 });
      });

      // zoom to bounds (locked zoom at target)
      try {
        layer.bringToFront();

        const b = layer.getBounds();
        const size = map.getSize();
        const pad = Math.max(40, Math.min(140, Math.round(Math.min(size.x, size.y) * 0.10)));
        map.setMinZoom(2); map.setMaxZoom(19);
        map.fitBounds(b, { padding: [pad, pad], maxZoom: 18, animate: false });
        const targetZoom = map.getZoom();
        const center = b.getCenter();
        map.setView(center, targetZoom, { animate: false });

        map.setMinZoom(targetZoom); map.setMaxZoom(targetZoom);
        map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable();
        map.boxZoom.disable(); map.keyboard.disable(); map.touchZoom.disable();
        if (zoomCtrl){ map.removeControl(zoomCtrl); zoomCtrl=null; }
      } catch(e){}

      // reflow fixes
      map.invalidateSize(true);
      requestAnimationFrame(()=>map.invalidateSize(true));
      setTimeout(()=>map.invalidateSize(true), 0);

      // show cursor ring logic
      if (typeof enableCursorRing === 'function') enableCursorRing(layer);

      focusedLayer = layer;
      allowNavigate = false;       // devine true când ring-ul e vizibil
      suppressNextMapClick = true; // ignorăm click-ul care a produs focusul

      // armăm click pe hartă pentru intrare în pagina zonei
      if (mapClickHandler) { map.off('click', mapClickHandler); mapClickHandler = null; }
      mapClickHandler = function(e){
        if (suppressNextMapClick) { suppressNextMapClick = false; return; }
        if (!focusedLayer || !allowNavigate) return;

        if (!focusedLayer.getBounds().contains(e.latlng)) return;
        const latlngs = focusedLayer.getLatLngs();
        const rings = Array.isArray(latlngs[0]) ? latlngs[0] : latlngs;
        if (!pointInPolygon(e.latlng, rings)) return;

        const z = focusedLayer._zone;
        if (!z || !z.id) return;

        try { sessionStorage.setItem('pf_zoneId', String(z.id)); } catch(_){}
        window.location.href = 'pag2.html?zoneId=' + encodeURIComponent(z.id);
      };
      map.on('click', mapClickHandler);
    }

    // ===== Build / rebuild zone layers =====
    function buildZones(){
      outlines.forEach(l=>map.removeLayer(l)); outlines.clear();
      ZONES.forEach(z=>{
        const base = styleMap[z.title] || { color:'#ffd400', weight:4, opacity:0.95, fill:true, fillOpacity:0.001, className:'zone-outline' };
        const layer = L.polygon(z.coords, base).addTo(map);
        layer._zone = z;

        outlines.set(z.title, layer);
        attachHover(layer, base.color || '#ffd400');

        const goFocus = (e)=>{
          if (focusedLayer === layer) return;
          if (e && e.originalEvent) {
            e.originalEvent.stopPropagation?.();
            e.originalEvent.preventDefault?.();
          }
          focusLayer(layer);
        };

        layer.on('click', goFocus);
        layer.on('tap', goFocus);
      });
    }
    buildZones();

    // ===== Admin (open/close + auth) =====
    const adminBtn = document.getElementById('adminBtn');
    const closeAdmin = document.getElementById('closeAdmin');
    const adminPanelEl = document.getElementById('adminPanel');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const passModal = document.getElementById('passModal');
    const passInput = document.getElementById('passInput');
    const passOk = document.getElementById('passOk');
    const passCancel = document.getElementById('passCancel');

    function showModal(){ modalBackdrop.style.display='block'; passModal.style.display='flex'; passInput.value=''; passInput.focus(); }
    function hideModal(){ modalBackdrop.style.display='none'; passModal.style.display='none'; }

    let adminOpen=false;
    function openAdmin(){
      if (typeof disableCursorRing === 'function') disableCursorRing();
      if (mapClickHandler) { map.off('click', mapClickHandler); mapClickHandler = null; }
      focusedLayer = null; allowNavigate=false; suppressNextMapClick=false;

      adminPanelEl.style.display='block'; adminOpen=true;
      const mode = (localStorage.getItem('pf_theme')==='light')?'light':'nightsoft';
      if(mode==='light') adminPanelEl.classList.add('light'); else adminPanelEl.classList.remove('light');
      enableFreeMap();
    }
    function closeAdminPanel(){
      adminPanelEl.style.display='none'; adminOpen=false;
      if (inDrawMode) toggleDraw();
      goHome();
    }

    const fireAdmin = (e)=>{ e.preventDefault(); e.stopPropagation(); if(!adminOpen) showModal(); else closeAdminPanel(); };
    ['click','pointerdown','mousedown','touchstart'].forEach(ev=>{
      adminBtn.addEventListener(ev, fireAdmin, {capture:true, passive:false});
    });
    passCancel.addEventListener('click', hideModal);
    passOk.addEventListener('click', ()=>{ if (passInput.value==='1234'){ hideModal(); openAdmin(); } else { passInput.value=''; passInput.placeholder='Wrong password'; passInput.focus(); }});
    passInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') passOk.click(); if(e.key==='Escape') hideModal(); });
    closeAdmin.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeAdminPanel(); });

    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); goHome(); });

    // ===== Admin editing (Leaflet.draw) =====
    const areaSelect = document.getElementById('areaSelect');
    const drawToggle = document.getElementById('drawToggle');
    const saveBtn    = document.getElementById('saveBtn');
    const clearBtn   = document.getElementById('clearBtn');

    // --- Populate zone dropdown
    function loadAreaOptions(){
      areaSelect.innerHTML='';
      ZONES.forEach(z=>{
        const opt=document.createElement('option');
        opt.value=z.title; opt.textContent=z.title;
        areaSelect.appendChild(opt);
      });
    }
    loadAreaOptions();

    // --- Extract polygon coords from layer
    function coordsFromLayer(layer){
      const rings = layer.getLatLngs();
      const outer = Array.isArray(rings[0]) ? rings[0] : rings;
      return outer.map(p=>[Number(p.lat.toFixed(6)), Number(p.lng.toFixed(6))]);
    }

    // --- Load selected zone into editor
    function loadAreaToEditor(title){
      drawnItems.clearLayers();
      const z = ZONES.find(x=>x.title===title);
      if (z && z.coords && z.coords.length){
        const layer = L.polygon(z.coords, {color:'#ffd400', weight:3, opacity:.95, fill:false});
        drawnItems.addLayer(layer);
        try { map.fitBounds(layer.getBounds(), {padding:[20,20]}); } catch(e){}
        map.invalidateSize(true);
        requestAnimationFrame(()=>map.invalidateSize(true));
        setTimeout(()=>map.invalidateSize(true), 0);
      }
    }

    // --- Save editor polygon back to zone
    function saveEditorToZone(){
      const title = areaSelect.value;
      let coords = null;
      drawnItems.eachLayer(l=>{ coords = coordsFromLayer(l); });
      if (!coords || !coords.length){ alert('No polygon to save. Draw or edit first.'); return; }
      const hit = ZONES.find(z=>z.title===title);
      if (hit) hit.coords = coords;
      buildZones();
      loadAreaToEditor(title);
    }

    // --- Clear coords for current zone
    function clearZone(){
      const title = areaSelect.value;
      const hit = ZONES.find(z=>z.title===title);
      if (hit){ hit.coords = []; }
      drawnItems.clearLayers();
      buildZones();
    }

    // --- Toggle draw mode
    function toggleDraw(){
      if (!inDrawMode){
        inDrawMode = true;
        drawToggle.classList.add('draw-on'); 
        drawToggle.textContent='✔ Done';
        enableFreeMap();
        if (typeof disableCursorRing === 'function') disableCursorRing();

        drawControl = new L.Control.Draw({
          position: 'topleft',
          edit: { featureGroup: drawnItems, remove: true },
          draw: {
            polygon: { allowIntersection:false, showArea:false, shapeOptions:{ color:'#ffd400', weight:3, opacity:.95, fill:false } },
            polyline:false, rectangle:false, circle:false, marker:false, circlemarker:false
          }
        });
        map.addControl(drawControl);
        loadAreaToEditor(areaSelect.value);
      } else {
        drawToggle.classList.remove('draw-on'); 
        drawToggle.textContent='✏ Draw';
        if (drawControl){ map.removeControl(drawControl); drawControl=null; }
        inDrawMode = false;
        goHome();
      }
    }

    // --- Admin editor event wiring
    drawToggle.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggleDraw(); });
    saveBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); saveEditorToZone(); });
    clearBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); if(confirm('Clear polygon for this zone?')) clearZone(); });
    areaSelect.addEventListener('change', ()=>{ if (inDrawMode) loadAreaToEditor(areaSelect.value); });

    map.on(L.Draw.Event.CREATED, (e)=>{ drawnItems.clearLayers(); drawnItems.addLayer(e.layer); });
    map.on(L.Draw.Event.EDITED, (e)=>{ /* live */ });

    // ===== Resize handling =====
    window.addEventListener('resize', ()=>map.invalidateSize());

    // ===== Cursor ring visibility sync -> navigation arming =====
    window.addEventListener('cursorRing:visible', ()=>{ allowNavigate = true; });
    window.addEventListener('cursorRing:hidden',  ()=>{ allowNavigate = false; });

/* ===========================
   WEATHER WIDGET – Google Weather API (final version)
   =========================== */
(function(){
  const GOOGLE_KEY = 'AIzaSyCBCXzrQ63_qOa1og73NaU_wr9YFt2sHmg';
  const lat = CITY_CENTER[0], lon = CITY_CENTER[1];

  const card  = document.getElementById('wxCard');
  const icon  = document.getElementById('wxIcon');  // <img>
  const temp  = document.getElementById('wxTemp');
  const desc  = document.getElementById('wxDesc');

  function applyWxTheme(){
    const isLight = (localStorage.getItem('pf_theme') === 'light');
    if (isLight) card.classList.add('light'); else card.classList.remove('light');
  }
  applyWxTheme();
  if (typeof themeBtn !== 'undefined' && themeBtn){
    themeBtn.addEventListener('click', ()=> setTimeout(applyWxTheme,0), {passive:true});
  }

  function fetchWithTimeout(resource, {timeout=8000}={}){
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), timeout);
    return fetch(resource, {signal:controller.signal}).finally(()=>clearTimeout(t));
  }

  // Icon-uri SVG simple
  const ICONS = {
    sun:   'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 24 24"><path fill="%23ffaa00" d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.8zm10.48 14.32l1.79 1.8l1.79-1.79l-1.8-1.8zM12 4V1h-0v3zm0 19v-3h0v3zM4 12H1v0h3zm19 0h-3v0h3zM6.76 19.16l-1.8 1.79l1.79 1.79l1.8-1.79zM17.24 4.84l1.8-1.79l-1.79-1.8l-1.8 1.8zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6"/></svg>',
    cloud: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 24 24"><path fill="%2399aabb" d="M6 19a4 4 0 1 1 .9-7.9A6 6 0 0 1 18 9a5 5 0 0 1 0 10z"/></svg>',
    rain:  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 24 24"><path fill="%2399aabb" d="M6 17a4 4 0 1 1 .9-7.9A6 6 0 0 1 18 7a5 5 0 0 1 0 10z"/><path fill="%230077ff" d="M8 22l1-3M12 22l1-3M16 22l1-3"/></svg>'
  };

  const CODE_RO = {
    CLEAR: 'Cer senin', PARTLY_CLOUDY: 'Parțial noros', MOSTLY_CLOUDY: 'Mai mult noros',
    CLOUDY: 'Noros', RAIN: 'Ploaie', LIGHT_RAIN: 'Ploaie slabă', HEAVY_RAIN: 'Ploaie puternică',
    THUNDERSTORM: 'Furtună', SNOW: 'Ninsori', FOG: 'Ceață'
  };

  const pickIcon = (codeStr='') => {
    if (/rain|drizzle|shower/i.test(codeStr)) return ICONS.rain;
    if (/cloud|overcast/i.test(codeStr))      return ICONS.cloud;
    return ICONS.sun;
  };

  // ===== Extractoare =====
  function walk(obj, cb, path=''){
    if (!obj || typeof obj !== 'object') return;
    for (const k of Object.keys(obj)){
      const v = obj[k];
      const p = path ? path + '.' + k : k;
      cb(v, k, p);
      if (v && typeof v === 'object') walk(v, cb, p);
    }
  }

  function findTemperatureC(obj){
    let best;
    walk(obj, (v,k)=>{
      if (!/temp/i.test(k)) return;
      let n = (typeof v === 'number') ? v
            : (v && typeof v === 'object' && typeof v.value === 'number') ? v.value
            : undefined;
      if (typeof n === 'number' && isFinite(n)){
        if (n > -80 && n < 65) best = n;
      }
    });
    return best;
  }

  function findCodeName(obj){
    let code = '';
    walk(obj, (v,k)=>{
      if (/code(Name)?$/i.test(k) && typeof v === 'string' && v.length <= 40) code = v;
    });
    if (!code && Array.isArray(obj?.weatherCode)) code = obj.weatherCode.join(' ');
    return code;
  }

  function findDescription(obj){
    let text = '';
    walk(obj, (v,k)=>{
      if (text) return;
      if (/(description|summary|phrase|text|weatherText)/i.test(k) && typeof v === 'string' && v.trim()){
        text = v.trim();
      }
      if (!text && /weatherCondition/i.test(k) && v && typeof v === 'object'){
        const d = v.description || v.text || v.summary;
        if (typeof d === 'string' && d.trim()) text = d.trim();
      }
    });
    return text;
  }

  async function loadWeather(){
    const url = "https://weather.googleapis.com/v1/currentConditions:lookup"
      + `?key=${encodeURIComponent(GOOGLE_KEY)}`
      + `&location.latitude=${lat}`
      + `&location.longitude=${lon}`
      + `&unitsSystem=METRIC`
      + `&languageCode=ro`;

    try{
      desc.textContent = 'Se încarcă…';
      icon.src = ICONS.sun;

      const res = await fetchWithTimeout(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} – ${await res.text()}`);
      const data = await res.json();
      const cc = (data?.currentConditions?.[0]) || data?.currentConditions || data || {};

      // === Temperatură (°C) – cu fallback-uri multiple
      let t = findTemperatureC(cc);

      if (!Number.isFinite(t)) {
        t = findTemperatureC({
          temperature: cc?.apparentTemperature ?? cc?.feelsLike ??
                       cc?.airTemperature ?? cc?.surfaceTemperature ??
                       cc?.temperature2m ?? cc?.temperatureMin ?? cc?.temperatureMax
        });
      }

      if (!Number.isFinite(t) && Array.isArray(data?.hourlyForecasts?.forecast) && data.hourlyForecasts.forecast.length) {
        const f0 = data.hourlyForecasts.forecast[0];
        t = findTemperatureC(f0);
      }

      if (Number.isFinite(t) && t > 65) {
        t = (t - 32) * 5 / 9;
      }

      temp.textContent = Number.isFinite(t) ? `${Math.round(t)}°C` : '--°C';

      // === Descriere meteo
      let code = findCodeName(cc);
      let d = findDescription(cc);
      if (!d && code){
        const key = code.toUpperCase().split(/[ ,]/)[0];
        d = CODE_RO[key] || code.replaceAll('_',' ').toLowerCase();
      }
      if (typeof d === 'string' && d.length) d = d[0].toUpperCase() + d.slice(1);
      desc.textContent = d || '—';

      icon.src = pickIcon(code || d || '');
      card.title = `Ultima actualizare: ${new Date().toLocaleTimeString('ro-RO')}`;
    }catch(err){
      temp.textContent = '--°C';
      desc.textContent = '—';
      icon.src = ICONS.sun;
      card.title = 'Eroare la încărcarea vremii';
      console.error('Weather (Google) error:', err);
    }
  }

  loadWeather();
  setInterval(loadWeather, 15*60*1000);
})();
/* ===== END WEATHER WIDGET ===== */



  </script>

  <!-- === CURSOR RING MODULE (cu evenimente) === -->
  <script>
  /* ==============================
     CURSOR RING MODULE (visual cue inside polygons)
     ============================== */
  (function () {
    const RING_RADIUS_PX = 28;
    const RING_STYLE = {
      color: '#00E0FF',
      weight: 2,
      opacity: 0.95,
      fillColor: '#00E0FF',
      fillOpacity: 0.08,
      interactive: false
    };

    let selectedPolygon = null;
    let ring = null;
    let mouseMoveHandler = null;
    let mouseOutHandler = null;
    let _map = null;
    let ringVisible = false;

    // --- Dispatch custom visibility events (used to arm navigation) ---
    function dispatch(name){
      window.dispatchEvent(new CustomEvent('cursorRing:' + name));
    }

    // --- Lazy create ring layer ---
    function ensureRing(mapInstance) {
      if (ring) return ring;
      ring = L.circleMarker([0, 0], { radius: RING_RADIUS_PX, ...RING_STYLE });
      ring.addTo(mapInstance);
      ring.setStyle({ opacity: 0, fillOpacity: 0 });
      return ring;
    }

    // --- Show/hide ring ---
    function showRingAt(latlng) {
      if (!ring) return;
      ring.setLatLng(latlng);
      ring.setStyle({ opacity: RING_STYLE.opacity, fillOpacity: RING_STYLE.fillOpacity });
      if (!ringVisible){ ringVisible = true; dispatch('visible'); }
    }

    function hideRing() {
      if (!ring) return;
      ring.setStyle({ opacity: 0, fillOpacity: 0 });
      if (ringVisible){ ringVisible = false; dispatch('hidden'); }
    }

    // --- Geometry util (duplicate by design: isolated module) ---
    function pointInPolygon(latlng, polyLatLngs) {
      const rings = Array.isArray(polyLatLngs[0]) ? polyLatLngs : [polyLatLngs];
      const x = latlng.lng, y = latlng.lat;
      let inside = false;
      for (let r = 0; r < rings.length; r++) {
        const ring = rings[r];
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
          const xi = ring[i].lng, yi = ring[i].lat;
          const xj = ring[j].lng, yj = ring[j].lat;
          const intersect = ((yi > y) !== (yj > y)) &&
                            (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
          if (intersect) inside = !inside;
        }
        if (inside) return true;
      }
      return false;
    }

    // --- Public API: enable/disable ring on a given polygon ---
    window.enableCursorRing = function (polygon) {
      try {
        _map = (typeof window !== 'undefined' && window.map) ? window.map : _map;
        if (!_map || !polygon) return;

        selectedPolygon = polygon;
        ensureRing(_map);
        hideRing();

        if (mouseMoveHandler) _map.off('mousemove', mouseMoveHandler);
        if (mouseOutHandler)  _map.off('mouseout', mouseOutHandler);

        mouseMoveHandler = function (e) {
          if (!selectedPolygon) { hideRing(); return; }
          const latlngs = selectedPolygon.getLatLngs();
          const rings = Array.isArray(latlngs[0]) ? latlngs[0] : latlngs;
          const inside = pointInPolygon(e.latlng, rings);
          if (inside) showRingAt(e.latlng); else hideRing();
        };

        mouseOutHandler = function () { hideRing(); };

        _map.on('mousemove', mouseMoveHandler);
        _map.on('mouseout', mouseOutHandler);
        _map.on('dragstart', hideRing);
        _map.on('zoomstart', hideRing);

      } catch (err) { console.error('enableCursorRing error:', err); }
    };

    window.disableCursorRing = function () {
      try {
        _map = (typeof window !== 'undefined' && window.map) ? window.map : _map;
        selectedPolygon = null;
        hideRing();
        if (_map && mouseMoveHandler) _map.off('mousemove', mouseMoveHandler);
        if (_map && mouseOutHandler)  _map.off('mouseout', mouseOutHandler);
        mouseMoveHandler = null;
        mouseOutHandler = null;
      } catch (err) { console.error('disableCursorRing error:', err); }
    };

    // util
    window.isCursorRingVisible = function(){ return !!ringVisible; };
  })();
  </script>

</body>
</html>
